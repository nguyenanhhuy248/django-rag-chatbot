{% extends 'base.html' %} {% load static %} {% block title %}Chat - Document Q&A
Assistant{% endblock %} {% block extra_css %}
<style>
  .chat-container {
    height: 70vh;
    background-color: #f8f9fa;
    border-radius: 10px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 20px;
  }
  .message {
    margin-bottom: 20px;
    max-width: 80%;
  }
  .message.user {
    margin-left: auto;
  }
  .message.bot {
    margin-right: auto;
  }
  .message-content {
    padding: 10px 15px;
    border-radius: 15px;
    position: relative;
  }
  .message.user .message-content {
    background-color: #007bff;
    color: white;
    border-bottom-right-radius: 5px;
  }
  .message.bot .message-content {
    background-color: #e9ecef;
    border-bottom-left-radius: 5px;
  }
  .message-time {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 5px;
  }
  .chat-input {
    padding: 20px;
    background-color: white;
    border-top: 1px solid #dee2e6;
  }
  .typing-indicator {
    display: none;
    margin-bottom: 20px;
  }
  .typing-indicator span {
    display: inline-block;
    width: 8px;
    height: 8px;
    background-color: #6c757d;
    border-radius: 50%;
    margin-right: 5px;
    animation: typing 1s infinite;
  }
  .typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
  }
  .typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
  }
  @keyframes typing {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-5px);
    }
  }
</style>
{% endblock %} {% block content %}
<div class="chat-container">
  <div class="chat-messages" id="chatMessages">
    {% for message in messages %}
    <div class="message user">
      <div class="message-content">{{ message.message }}</div>
      <div class="message-time">{{ message.timestamp|date:"Y-m-d H:i:s" }}</div>
    </div>
    <div class="message bot">
      <div class="message-content">{{ message.response }}</div>
      <div class="message-time">{{ message.timestamp|date:"Y-m-d H:i:s" }}</div>
    </div>
    {% endfor %}
    <div class="typing-indicator" id="typingIndicator">
      <div class="message bot">
        <div class="message-content">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>
  </div>
  <div class="chat-input">
    <form id="chatForm" class="d-flex gap-2">
      <input
        type="text"
        id="messageInput"
        class="form-control"
        placeholder="Type your message..."
        required
      />
      <button type="submit" class="btn btn-primary">Send</button>
    </form>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const chatForm = document.getElementById("chatForm");
    const messageInput = document.getElementById("messageInput");
    const chatMessages = document.getElementById("chatMessages");
    const typingIndicator = document.getElementById("typingIndicator");

    // Scroll to bottom of chat
    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    scrollToBottom();

    // Add message to chat
    function addMessage(message, isUser = true) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${isUser ? "user" : "bot"}`;

      const contentDiv = document.createElement("div");
      contentDiv.className = "message-content";
      contentDiv.textContent = message;

      const timeDiv = document.createElement("div");
      timeDiv.className = "message-time";
      timeDiv.textContent = new Date().toLocaleString();

      messageDiv.appendChild(contentDiv);
      messageDiv.appendChild(timeDiv);

      typingIndicator.insertAdjacentElement("beforebegin", messageDiv);
      scrollToBottom();
    }

    // Show/hide typing indicator
    function setTypingIndicator(visible) {
      typingIndicator.style.display = visible ? "block" : "none";
      if (visible) scrollToBottom();
    }

    // Handle form submission
    chatForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      const message = messageInput.value.trim();
      if (!message) return;

      // Add user message
      addMessage(message, true);
      messageInput.value = "";

      // Show typing indicator
      setTypingIndicator(true);

      try {
        const response = await fetch("/send_message/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
              .value,
          },
          body: JSON.stringify({ message: message }),
        });

        const data = await response.json();

        if (data.status === "success") {
          // Add bot response
          addMessage(data.response, false);
        } else {
          console.error("Error:", data.message);
        }
      } catch (error) {
        console.error("Error:", error);
      } finally {
        setTypingIndicator(false);
      }
    });
  });
</script>
{% endblock %}
